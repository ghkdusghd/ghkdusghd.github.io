---
title: "[íŠ¸ëŸ¬ë¸”ìŠˆíŒ…] JWT claims ëŒ€ê´„í˜¸ ì‚¬ìš© ì—ëŸ¬"
parent: JWT
nav_order: 1

tags:
  - [spring security, jwt]

toc: true
toc_sticky: true

date: 2024-10-29
last_modified_at: 2024-10-29
---

> ì‹œíë¦¬í‹° + JWT í† í°ì„ ê²°í•©í•˜ì—¬ êµ¬í˜„í•˜ëŠ” ê³¼ì •ì—ì„œ ë°œìƒí•œ ì—ëŸ¬. í† í° ë°œê¸‰ì€ ì˜ ë˜ëŠ”ë° ê¶Œí•œ ì¸ì¦ì´ í•„ìš”í•œ ìš”ì²­ì„ ë³´ëƒˆì„ ë•Œ ê³„ì† 403 ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.

### ğŸš€ ì‚¬ì „ ì •ë¦¬

- í† í° ì¸ì¦ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ROLE_ADMIN ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìë§Œ "/admin/\*\*" ê²½ë¡œë¡œ ìš”ì²­í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í–ˆë‹¤.

- ADMIN ê¶Œí•œì„ ê°€ì§„ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ "/admin/test" ê²½ë¡œë¡œ POST ìš”ì²­í•˜ë©´ "login success" ë¼ëŠ” ë¬¸ìì—´ì´ ë°˜í™˜ë˜ë©´ ì„±ê³µì´ë‹¤.

### ğŸ”¥ ë¬¸ì œ ìƒí™©

DBì—ì„œ ê¶Œí•œ ì •ë³´ëŠ” varchar ë¡œ ì €ì¥ë˜ê¸° ë•Œë¬¸ì— User ë„ë©”ì¸ì—ì„œë„ String í˜•ìœ¼ë¡œ ì‘ì„±í–ˆë‹¤. ìš°ë¦¬ ì„œë¹„ìŠ¤ëŠ” USER, ADMIN ê¶Œí•œ ë‘ ì¢…ë¥˜ë¡œë§Œ ë¶„ë¥˜í•˜ê³  ìˆê¸° ë•Œë¬¸ì— í•œ ìœ ì €ê°€ ì—¬ëŸ¬ ê°œì˜ ê¶Œí•œì„ ê°€ì§ˆ í•„ìš”ê°€ ì—†ì–´ì„œ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì ì ˆí–ˆìœ¼ë‚˜, Spring Security ì˜ ì‹œìŠ¤í…œìƒ ê¶Œí•œ ì •ë³´ë¥¼ Collection í˜•íƒœë¡œ ë°˜í™˜í•´ì•¼ í–ˆë‹¤.

```java
package kr.kh.backend.domain;

@Builder
@Getter @Setter
@ToString(exclude = "password")
public class User implements UserDetails {

    private int id;
    private String email;
    private String nickname;
    private String password;
    private String platform;
    private String roles;


    @Override
    public String getUsername() {
        return nickname;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return roles != null && !roles.isEmpty() ?
                List.of(roles.split(",")).stream()
                        .map(SimpleGrantedAuthority::new)
                        .collect(Collectors.toList()) :
                new ArrayList<>();
    }

    // ì´í•˜ ìƒëµ...

}

```

ê¶Œí•œ ì •ë³´ëŠ” ê·¸ë ‡ê²Œ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ì €ì¥ë˜ì—ˆê³ , í† í° ë°œê¸‰ ê³¼ì •ì—ì„œ ê¶Œí•œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ë•Œ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ ê·¸ëŒ€ë¡œ ë°›ì•„ì„œ ê·¸ëŒ€ë¡œ í† í°ì— ë„£ì–´ì£¼ì—ˆë‹¤.

```java
// (ìˆ˜ì • ì „) ìœ ì € ê¶Œí•œ ê°€ì ¸ì˜¤ê¸°
List<String> authoritiesList = authentication.getAuthorities().stream()
        .map(GrantedAuthority::getAuthority)
        .collect(Collectors.toList());

// access token ìƒì„± : ì¸ì¦ëœ ì‚¬ìš©ìì˜ ê¶Œí•œ ì •ë³´ì™€ ë§Œë£Œ ì‹œê°„ì„ ë‹´ëŠ”ë‹¤. (1ì‹œê°„)
Date expiration = new Date(now + 1000 * 60 * 60);
String accessToken = Jwts.builder()
        .setSubject(authentication.getName())
        .claim("auth", authoritiesList)
        .setExpiration(expiration)
        .signWith(key, SignatureAlgorithm.HS256)
        .compact();
```

ê·¸ ê²°ê³¼, ì•„ë˜ì™€ ê°™ì€ í˜ì´ë¡œë“œ í˜•íƒœê°€ ë˜ì—ˆê³ , í† í° ë°œê¸‰ ê³¼ì •ì—ì„œëŠ” ë¬¸ì œê°€ ì—†ì—ˆê¸°ì— ê·¸ëŒ€ë¡œ ì§„í–‰í–ˆë‹¤. ê·¸ëŸ¬ë‚˜ ê¶Œí•œ ì¸ì¦ ê³¼ì •ì—ì„œ 403 ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.

<img width="569" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-10-06 á„‹á…©á„’á…® 2 35 08" src="https://github.com/user-attachments/assets/73d5c7c5-3e8c-4102-9fe5-b5afbeae0b16">

### âœ¨ í•´ê²°

ì•„ë¬´ë¦¬ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ì—¬ ëŒë ¤ë´ë„ JWTAuthFilter ë¥¼ ë¬¸ì œ ì—†ì´ í†µê³¼í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì˜€ë‹¤. ì¸ì¦ëœ ê°ì²´ê°€ ì–´ë–¤ ì‹ìœ¼ë¡œ ì €ì¥ë˜ì–´ ìˆë‚˜ í™•ì¸í•´ ë³´ê¸° ìœ„í•´ SecurityContextHolder ë¥¼ ë¡œê·¸ë¡œ ì°ì–´ë³´ì•˜ëŠ”ë° ê¶Œí•œì€ ROLE_ADMIN ìœ¼ë¡œ ë“¤ì–´ê°€ ìˆëŠ” ê²Œ ë§ì•˜ê³ , Authenticated = true ë¡œ ê¶Œí•œ ì¸ì¦ì— ì„±ê³µí•œ ê²ƒì´ í™•ì¸ë˜ì—ˆë‹¤.

```
2024-10-06T14:38:02.034+09:00  INFO 91285 --- [backend] [nio-8080-exec-2] k.kh.backend.security.jwt.JwtAuthFilter  : success JWT Filter ! SecurityContextHolder = SecurityContextImpl [Authentication=UsernamePasswordAuthenticationToken [Principal=org.springframework.security.core.userdetails.User [Username=tester7, Password=[PROTECTED], Enabled=true, AccountNonExpired=true, CredentialsNonExpired=true, AccountNonLocked=true, Granted Authorities=[ROLE_ADMIN]], Credentials=[PROTECTED], Authenticated=true, Details=null, Granted Authorities=[ROLE_ADMIN]]]
```

ì›ì¸ì„ ì°¾ì§€ ëª»í•˜ë˜ ì™€ì¤‘ì— í˜ì´ë¡œë“œì˜ ëŒ€ê´„í˜¸[] ê°€ ì‹ ê²½ì“°ì´ê¸° ì‹œì‘í–ˆë‹¤. ì´ì „ì— ë‘ ì°¨ë¡€ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ JWT í† í°ì„ ì‚¬ìš©í–ˆì„ ë•Œ, í˜ì´ë¡œë“œëŠ” ì „ë¶€ ë¬¸ìì—´ì´ì—ˆë˜ ê²ƒìœ¼ë¡œ ê¸°ì–µì„ í•´ì„œ í˜¹ì‹œ ëª°ë¼ String í˜•ìœ¼ë¡œ ë‹¤ì‹œ ë³€í™˜í•˜ì—¬ í† í°ì— ì €ì¥í•´ì£¼ì—ˆë‹¤.

ì´ ë°©ì‹ìœ¼ë¡œ ì‹¤í–‰í•´ë³¸ ê²°ê³¼ ì›í•˜ë˜ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.

```java
// (ìˆ˜ì • í›„) ìœ ì € ê¶Œí•œ ê°€ì ¸ì˜¤ê¸°
String authorities = authentication.getAuthorities().stream()
        .map(GrantedAuthority::getAuthority)
        .collect(Collectors.joining(","));

// access token ìƒì„± : ì¸ì¦ëœ ì‚¬ìš©ìì˜ ê¶Œí•œ ì •ë³´ì™€ ë§Œë£Œ ì‹œê°„ì„ ë‹´ëŠ”ë‹¤. (1ì‹œê°„)
Date expiration = new Date(now + 1000 * 60 * 60);
String accessToken = Jwts.builder()
        .setSubject(authentication.getName())
        .claim("auth", authorities)
        .setExpiration(expiration)
        .signWith(key, SignatureAlgorithm.HS256)
        .compact();
```

<img width="576" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-10-06 á„‹á…©á„’á…® 2 50 11" src="https://github.com/user-attachments/assets/63a12ead-5ae7-4d60-9f74-5aa3686e9cc3">

<img width="1021" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º 2024-10-06 á„‹á…©á„’á…® 2 21 17" src="https://github.com/user-attachments/assets/eb9d08af-43e7-45ef-8e13-9e8b9b22100f">

### ğŸ’¡ ì´í›„ì˜ ê³ ì°°...

ê·¸ëŸ°ë° ì™œ ëŒ€ê´„í˜¸ëŠ” ì¸ì‹í•˜ì§€ ëª»í•˜ëŠ” ê²ƒì¼ê¹Œ? ê¶ê¸ˆí•´ì„œ ê²€ìƒ‰í•´ë´¤ëŠ”ë° ìŠ¤í”„ë§ì—ì„œëŠ” JWT ì—ì„œ auth í•­ëª©ì´ ëŒ€ê´„í˜¸ë¡œ ê°ì‹¸ì¸ ë°°ì—´ í˜•ì‹ì´ë”ë¼ë„ ì´ë¥¼ ë¬¸ìì—´ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. í•˜ì§€ë§Œ ê¶Œí•œ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì¸ì‹í•˜ê¸° ìœ„í•´ì„œëŠ” Collection<GrantedAuthority> í˜•íƒœë¡œ ë°˜í™˜í•´ì•¼ í•œë‹¤ëŠ”ë°, ì•„ë§ˆ ê¸°ì¡´ì— ë‚´ê°€ ì‘ì„±í–ˆë˜ ì½”ë“œë¡œëŠ” auth í•­ëª©ì„ íŒŒì‹±í•˜ëŠ” ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ìˆì—ˆë˜ ë“¯ í•˜ë‹¤.

ì´ëŸ° ì‹ìœ¼ë¡œ... ëŒ€ê´„í˜¸ì™€ ë”°ì˜´í‘œë¥¼ ì œê±°í•  ìˆ˜ ìˆë„ë¡ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒë„ í•˜ë‚˜ì˜ ë°©ë²•ì´ì—ˆì„ ìˆ˜ ìˆë‹¤. ë‹¤ë§Œ ë‚´ ê²½ìš°ì—ëŠ” ì–´ì°¨í”¼ ê¶Œí•œ ë¡¤ì€ í•œ ê°œ ë¿ì´ê¸° ë•Œë¬¸ì— í† í°ì—ë„ ë¬¸ìì—´ í•˜ë‚˜ë§Œ ë“¤ì–´ê°€ëŠ” ê²ƒì´ ê¹”ë”í•  ë“¯ í•˜ì—¬ ì•„ë˜ ë°©ì‹ì„ ì‹œë„í•´ë³´ì§€ëŠ” ì•Šì•˜ë‹¤.

```java
@Override
public Collection<? extends GrantedAuthority> getAuthorities() {
    if (roles != null && !roles.isEmpty()) {
        return Arrays.stream(roles.replaceAll("[\\[\\]\"]", "").split(","))
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());
    }
    return new ArrayList<>();
}

```

íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ë ! ì´ì œ oauth ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ë³´ëŸ¬ ê°€ì•¼ê² ë‹¤.